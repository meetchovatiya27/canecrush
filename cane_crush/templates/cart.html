{% extends 'base_main.html' %}
{% load static %}
{% block content %}
<div id="notificationsContainer">
</div>
<div class="untree_co-section before-footer-section">
    <div class="container">
        <div class="row mb-5">
            <form class="col-md-12" method="post" id="cart-form">
                {% csrf_token %}
                {% if cart_items %}
                <div class="site-blocks-table">
                    <table class="table">
                        <tbody>
                        {% for item in cart_items %}
                        <tr data-item-id="{{ item.id }}">
                            <td class="item-id" hidden="">{{ item.id }}</td>
                            <td class="item-stock" hidden="">{{ item.product.stock }}</td>
                            <td class="product-thumbnail">
                                <a href="{% url 'product' item.product.slug %}">
                                    <img src="{{ item.product.main_image.url }}" alt="Image" class="img-fluid">
                                </a>
                            </td>
                            <td class="product-name">
                                <a style="color: #000; text-decoration: none;font-weight: bold;font-size: 18px;"
                                   href="{% url 'product' item.product.slug %}" class="text-black">
                                    {{ item.product.name.title }}</a>
                            </td>
                            <td class="product-pack-size">{{ item.packsize }}</td>
                            <td class="product-price">‚Çπ<span class="price">{{ item.price }}</span></td>
                            <td>
                                <div class="input-group mb-3 d-flex align-items-center quantity-container"
                                     style="max-width: 120px;">
                                    <div class="input-group-prepend">
                                        <button class="btn btn-outline-black decrease" type="button" data-item-id="{{ item.id }}">&minus;
                                        </button>
                                    </div>
                                    <input type="text" class="form-control text-center quantity-amount"
                                           value="{{ item.quantity }}" aria-label="Example text with button addon"
                                           aria-describedby="button-addon1" data-product-id="{{ item.product.id }}">
                                    <div class="input-group-append">
                                        <button class="btn btn-outline-black increase" type="button">&plus;</button>
                                    </div>
                                </div>
                            </td>
                            <td class="total-price">‚Çπ<span class="total">{{ item.get_total_price }}</span></td>
                            <td>
                                <button type="button" class="btn btn-link p-0 delete-item-btn" data-item-id="{{ item.id }}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="row mb-5">
                            <div class="col-md-6 mb-3 mb-md-0">
                                <a href="{% url 'products' %}" class="btn btn-outline-black btn-sm btn-block">Continue Shopping</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 pl-5">
                        <div class="row justify-content-end">
                            <div class="col-md-7">
                                <div class="row">
                                    <div class="col-md-12 text-right border-bottom mb-5">
                                        <h3 class="text-black h4 text-uppercase">Cart Totals</h3>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <span class="text-black">Subtotal</span>
                                    </div>
                                    <div class="col-md-6 text-right">
                                        <strong class="text-black">‚Çπ<span id="subtotal">{{total_amount}}</span></strong>
                                    </div>
                                </div>
                                <div class="row mb-5">
                                    <div class="col-md-6">
                                        <span class="text-black">Total</span>
                                    </div>
                                    <div class="col-md-6 text-right">
                                        <strong class="text-black">‚Çπ<span id="total">{{total_amount}}</span></strong>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <button class="btn btn-black btn-lg py-3 btn-block" type="button" id="checkoutButton">Proceed To Checkout</button>
                                    </div>
                                </div>                                
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="empty-cart-image">
                    <img src="{% static 'images/collect_images/empty_cart.png' %}" alt="Empty Cart" class="img-fluid" width="500px"
                         height="500px">
                    <br>
                    <p style="font-size:20px ; font-weight: bold;  font-family: Arial, sans-serif;">Your cart is empty</p>
                </div>
                <div class=" d-flex justify-content-center">
                    <a href="{% url 'products' %}" class="btn btn-outline-black btn-sm btn-block">Continue Shopping</a>
                </div>
                {% endif %}
            </form>
        </div>
    </div>
</div>

<script>
$(document).ready(function () {

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            document.cookie.split(';').forEach(cookie => {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                }
            });
        }
        return cookieValue;
    }

    function calculateTotalPrice() {
        let subtotal = 0;
        $('.total').each(function () {
            subtotal += parseFloat($(this).text());
        });
        $('#subtotal').text(subtotal.toFixed(2));
        $('#total').text(subtotal.toFixed(2));
    }

    function updateRowTotal(row, quantity) {
        let price = parseFloat(row.find('.price').text());
        let total = price * quantity;
        row.find('.total').text(total.toFixed(2));
    }

    function updateQuantityOnServer(itemId, quantity) {
        return $.ajax({
            url: '/update_cart_quantity/',
            type: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            data: {
                'item_id': itemId,
                'quantity': quantity
            }
        });
    }

    // ‚ûï INCREASE
    $('.increase').click(function () {
        let row = $(this).closest('tr');
        let input = row.find('.quantity-amount');
        let stock = parseInt(row.find('.item-stock').text());
        let qty = parseInt(input.val());
        let itemId = row.data('item-id');

        if (qty < stock) {
            qty++;
            input.val(qty);
            updateRowTotal(row, qty);
            calculateTotalPrice();
            
            // Update server
            updateQuantityOnServer(itemId, qty).fail(function() {
                alert('Failed to update quantity');
                qty--;
                input.val(qty);
                updateRowTotal(row, qty);
                calculateTotalPrice();
            });
        } else {
            alert('Maximum stock reached');
        }
    });

    // ‚ûñ DECREASE
    $('.decrease').click(function () {
        let row = $(this).closest('tr');
        let input = row.find('.quantity-amount');
        let qty = parseInt(input.val());
        let itemId = row.data('item-id');

        if (qty > 1) {
            qty--;
            input.val(qty);
            updateRowTotal(row, qty);
            calculateTotalPrice();
            
            // Update server
            updateQuantityOnServer(itemId, qty).fail(function() {
                alert('Failed to update quantity');
                qty++;
                input.val(qty);
                updateRowTotal(row, qty);
                calculateTotalPrice();
            });
        } else {
            // If quantity is 1, delete the item
            if (confirm('Remove this item from cart?')) {
                deleteItem(row, itemId);
            }
        }
    });

    // üóëÔ∏è DELETE ITEM
    function deleteItem(row, itemId) {
        $.ajax({
            url: '/delete_cart/' + itemId + '/',
            type: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            success: function () {
                row.remove();
                calculateTotalPrice();
                
                // Check if cart is empty
                if ($('.table tbody tr').length === 0) {
                    location.reload();
                }
            },
            error: function () {
                alert('Failed to delete item');
            }
        });
    }

    // üóëÔ∏è DELETE BUTTON CLICK
    $('.delete-item-btn').click(function () {
        if (confirm('Are you sure you want to remove this item?')) {
            let row = $(this).closest('tr');
            let itemId = $(this).data('item-id');
            deleteItem(row, itemId);
        }
    });

    // üõí CHECKOUT BUTTON
    $('#checkoutButton').click(function(e) {
        e.preventDefault();
        
        // Check if table exists and has items
        if (!$('.table').length || $('.table tbody tr').length === 0) {
            alert('Your cart is empty!');
            return;
        }
        
        // Show loading state
        $(this).prop('disabled', true).text('Processing...');
        
        // Use AJAX to send to server (which handles encoding properly)
        $.ajax({
            url: '/send_whatsapp_message/',
            type: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            success: function(response) {
                if (response.success && response.url) {
                    // Open WhatsApp
                    window.open(response.url, '_blank');
                    // Reset button
                    $('#checkoutButton').prop('disabled', false).text('Proceed To Checkout');
                } else {
                    $('#checkoutButton').prop('disabled', false).text('Proceed To Checkout');
                    alert('Error processing checkout. Please try again.');
                }
            },
            error: function(xhr) {
                $('#checkoutButton').prop('disabled', false).text('Proceed To Checkout');
                
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    let errorMsg = xhr.responseJSON.error;
                    
                    // Special handling for configuration error
                    if (errorMsg === 'WhatsApp number not configured') {
                        alert('‚ö†Ô∏è WhatsApp Configuration Required\n\n' +
                              'Please add the following to your settings.py:\n\n' +
                              'WHATSAPP_OWNER_NUMBER = "919876543210"\n\n' +
                              'Format: country_code + phone_number (no + or spaces)\n' +
                              'Example: India = 91, US = 1, UK = 44');
                    } else {
                        alert('Error: ' + errorMsg);
                    }
                } else {
                    alert('Error processing checkout. Please try again.');
                }
            }
        });
    });

    calculateTotalPrice();
});
</script>
            
{% endblock %}